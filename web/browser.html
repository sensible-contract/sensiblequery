<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <title>bsv browser</title>
    <style type="text/css">
     body {
       font-size: 12px;
     }
    </style>
  </head>
  <body>
    <div class="container-fluent" id="app">
      <!-- nav -->
      <nav class="navbar navbar-expand navbar-light bg-light">
        <a class="navbar-brand">BSV browser</a>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link"
                 v-on:click="showBlock=true; showTxs=false; showTx=false; showAddress=false"
                 href="#">Block</a>
            </li>
            <li class="nav-item">
              <a class="nav-link"
                 v-on:click="showBlock=false; showTxs=true; showTx=false; showAddress=false"
                 href="#">Txs</a>
            </li>
            <li class="nav-item">
              <a class="nav-link"
                 v-on:click="showBlock=false; showTxs=false; showTx=true; showAddress=false"
                 href="#">Tx</a>
            </li>
            <li class="nav-item">
              <a class="nav-link"
                 v-on:click="showBlock=false; showTxs=false; showTx=false; showAddress=true"
                 href="#">Address</a>
            </li>
          </ul>
        </div>
        <form class="form-inline col-7">
          <input class="form-control mr-sm-2 col" type="search"
                 v-model="navInputValue"
                 placeholder="Search" aria-label="Search">
          <a class="btn btn-outline-success my-2 my-sm-0"
             v-on:click="pressNavButton">Go</a>
        </form>
      </nav>

      <div class="col">
        <div class="alert alert-info" role="alert">
          {{message}}
        </div>

        <!-- blocks -->
        <div v-if="showBlock">

          <h3> Blocks </h3>

          <div class="row justify-content-center">
            <div class="col-1">
              <div class="btn-group btn-group-lg mr-2" role="group" aria-label="First group">
                <a class="btn btn-secondary mb-2" v-on:click="viewBlockRange(-pageSize)" title="prev page">-</a>
              </div>
            </div>

            <div class="col-4">
              <form class="form-inline col">
                <div class="form-group col">
                  <label for="blockStartHeight" class="sr-only">Start</label>
                  <input type="text" class="form-control col" v-model="blockStartHeight" id="blockStartHeight"
                         placeholder="input start blk height">
                </div>
              </form>
            </div>

            <div class="col-1">
              <div class="btn-group btn-group-lg mr-2" role="group" aria-label="First group">
                <a class="btn btn-secondary mb-2" v-on:click="viewBlockRange(pageSize)" title="next page">+</a>
              </div>
            </div>

            <div class="col-1">
              <div class="btn-group btn-group-lg mr-2" role="group" aria-label="First group">
                <a class="btn btn-primary mb-2" v-on:click="viewBlockRange(0)" title="View Blocks">Go</a>
              </div>
            </div>
          </div>

          <table class="table">
            <thead>
              <tr>
                <th class="text-right">#</th>
                <th class="text-center">block id</th>
                <th class="text-right">tx count</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="blk in Blocks">
                <td class="text-right"><samp>{{ blk.height }}</samp></td>
                <td class="text-center">
                  <a type="button"
                     v-on:click="viewBlockHeightTxs(blk.height, blk.id);showBlock=false; showTxs=true"
                     title="View Txs"
                     class="btn-link"><samp>{{ blk.id }}</samp></a></td>
                <td class="text-right"><samp>{{ blk.ntx }}</samp></td>
              </tr>
            </tbody>
          </table>

        </div>

        <!-- txs -->
        <div v-if="showTxs">

          <h3> Txs <small>in block</small></h3>

          <div class="row">
            <div class="col">

              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th class="text-right">BlockId:</th>
                    <th class="text-left"><samp>{{currBlockId}}</samp></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th class="text-right">Tx Count:</th>
                    <td class="text-left"><samp> {{ currBlockTxs.length }} </samp></td>
                  </tr>
                </tbody>
              </table>

            </div>
          </div>

          <table class="table">
            <thead>
              <tr>
                <th class="text-right">#</th>
                <th class="text-center">tx id</th>
                <th class="text-right">txin count</th>
                <th class="text-right">txout count</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="tx in currBlockTxs">
                <td class="text-right"><samp>{{ tx.idx }}</samp></td>
                <td class="text-center">
                  <a type="button"
                     v-on:click="viewTxInsInside(tx.height, tx.txid); viewTxOutsInside(tx.height, tx.txid); showTxs=false; showTx=true"
                     title="View tx detail"
                     class="btn-link"><samp>{{ tx.txid }}</samp></a></td>
                <td class="text-right"><samp>{{ tx.nIn }}</samp></td>
                <td class="text-right"><samp>{{ tx.nOut }}</samp></td>
              </tr>
            </tbody>
          </table>

        </div>

        <!-- tx -->
        <div v-if="showTx">

          <h3> Tx </h3>

          <div class="row">
            <div class="col">

              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th class="text-right">TxId:</th>
                    <th class="text-left"><samp>{{currTxIdForIn}}</samp></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th class="text-right">Fee:</th>
                    <td class="text-left"><samp> {{((currTxIdInputValue-currTxIdOutputValue)/100000000.0)}} </samp></td>
                  </tr>
                </tbody>
              </table>

            </div>
          </div>

          <div class="row">
            <div class="col-6">

              <table class="table">
                <thead>
                  <tr>
                    <th class="text-left"></th>
                    <th class="text-right">#</th>
                    <th class="text-center">{{currTxIns.length}} Inputs</th>
                    <th class="text-right">{{(currTxIdInputValue/100000000.0)}}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="txin in currTxIns">
                    <td class="text-left">
                      <a type="button"
                         v-on:click="viewTxInsInside(txin.height_txo, txin.utxid); viewTxOutsInside(txin.height_txo, txin.utxid)"
                         class="btn-link"><samp>❰</samp></a>
                    </td>
                    <td class="text-right">
                      <small><samp>{{txin.idx}}</samp></small>
                    </td>
                    <td class="text-left">
                      <a type="button"
                         v-on:click="viewTxOutpointByAddress(txin.address); showAddress=true; showTx=false"
                         class="btn-link"><samp>{{ txin.address }}</samp></a>
                      <div><small><samp>{{ txin.script_type }}</small></samp></div>
                    </td>
                    <td class="text-right">
                      <small><samp>{{ (txin.satoshi/100000000.0) }}</samp></small>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="col-6">

              <table class="table">
                <thead>
                  <tr>
                    <th class="text-right">#</th>
                    <th class="text-center">{{currTxOuts.length}} Outputs</th>
                    <th class="text-right">{{(currTxIdOutputValue/100000000.0)}}</th>
                    <th class="text-right"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="txout in currTxOuts">
                    <td class="text-right">
                      <small><samp>{{txout.vout}}</samp></small>
                    </td>
                    <td class="text-left">
                      <a type="button"
                         v-on:click="viewTxOutpointByAddress(txout.address); showAddress=true; showTx=false"
                         title="View TxOutput"
                         class="btn-link"><samp>{{ txout.address }}</samp></a>
                      <div><small><samp>{{ txout.script_type }}</small></samp></div>
                    </td>
                    <td class="text-right">
                      <small><samp>{{ (txout.satoshi/100000000.0) }}</samp></small>
                    </td>
                    <td class="text-right">
                      <a type="button"
                         v-on:click="viewTxOutsStatus(txout.txid, txout.vout)"
                         class="btn-link"><samp>❱</samp></a>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- address -->
        <div v-if="showAddress">

          <h3> Address : <small><samp>{{currAddress}}<samp></small></h3>

            <table class="table">
              <thead>
                <tr>
                  <th class="text-right">#</th>
                  <th class="text-center">utxo</th>
                  <th class="text-center">script type</th>
                  <th class="text-right">value</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(txout, index) in currAddressTxOuts">
                  <td class="text-right"><samp>{{ index }}</samp></td>
                  <td class="text-left"><samp>{{ txout.txid }}:{{ txout.vout }}</samp></td>
                  <td class="text-center"><samp>{{ txout.script_type }}</samp></td>
                  <td class="text-right"><samp>{{ txout.satoshi/100000000.0 }}</samp></td>
                </tr>
              </tbody>
            </table>
        </div>
      </div>
    </div>

    <!-- script -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
    <script src="https://cdn.bootcss.com/axios/0.18.0/axios.min.js"></script>
    <script>
        const app = new Vue({
            el: '#app',
            data: {
              /* apiPoint: "http://120.92.153.221:5555/",*/

              apiPoint: "http://localhost:8000/",

              message: "",

                blockStartHeight: 0,
                pageSize: 64,

              navInputValue: "",

                showBlock: true,
                showTxs: false,
                showTx: false,
                showAddress: false,

                currBlockId: '',
                Blocks: [],
                currBlockTxs: [],
                currTxIns: [],
                currTxOuts: [],
                currAddressTxOuts: [],

                currTxInsOutpoint: [],
                currTxIdForIn: "",
                currTxIdForOut: "",

              currTxIdInputValue: 0,
              currTxIdOutputValue: 0,

              currAddress: "",

            },
            created: function () {
              this.viewBlockRange(0)
              /* this.viewBlockPrev(100)*/
            },
            methods: {
              pressNavButton: function () {
                if (this.showBlock) {
                  this.viewBlockById(this.navInputValue)
                } else if (this.showTxs) {
                  this.viewBlockIdTxs(this.navInputValue)
                } else if (this.showTx) {
                  this.viewTxIns(this.navInputValue)
                  this.viewTxOuts(this.navInputValue)
                } else if (this.showAddress) {
                  this.viewTxOutpointByAddress(this.navInputValue)
                }
              },

              viewBlockRange: function (step) {
                this.blockStartHeight = parseInt(this.blockStartHeight) + step
                blockEndHeight = this.blockStartHeight + this.pageSize

                axios
                  .get(this.apiPoint + "blocks/"+ this.blockStartHeight + "/" + blockEndHeight)
                  .then(
                    response => {
                      this.Blocks = response.data.data
                    }
                  )
              },

              viewBlockById: function (blkid) {
                axios
                  .get(this.apiPoint + "block/id/"+ blkid)
                  .then(
                    response => {
                      this.blockStartHeight = response.data.data.height
                      this.viewBlockRange(0)
                      /* this.viewBlockIdTxs(blkid)*/
                    }
                  )
              },

              viewBlockIdTxs: function (blkid) {
                this.currBlockId = blkid
                this.currBlockTxs = []
                axios
                  .get(this.apiPoint + "block/txs/"+ blkid)
                  .then(
                    response => {
                      this.currBlockTxs = response.data.data
                    }
                  )
              },

              viewBlockHeightTxs: function (height, blkid) {
                this.currBlockId = blkid
                this.currBlockTxs = []
                axios
                  .get(this.apiPoint + "height/"+ height +"/block/txs")
                  .then(
                    response => {
                      this.currBlockTxs = response.data.data
                    }
                  )
              },

              viewTxIns: function (txid) {
                this.updateTxIns(txid, this.apiPoint + "tx/"+ txid +"/ins")
              },
              viewTxOuts: function (txid) {
                this.updateTxOuts(txid, this.apiPoint + "tx/"+ txid +"/outs")
              },

              viewTxInsInside: function (height, txid) {
                this.updateTxIns(txid, this.apiPoint + "height/"+ height +"/tx/"+ txid +"/ins")
              },
              viewTxOutsInside: function (height, txid) {
                this.updateTxOuts(txid, this.apiPoint + "height/"+ height +"/tx/"+ txid +"/outs")
              },

              viewTxOutsStatus: function (txid, idx) {
                let url = this.apiPoint + "tx/"+ txid +"/out/"+idx+"/spent"
                axios
                  .get(url)
                  .then(
                    response => {
                      if (response.data.code == 0) {
                        this.viewTxInsInside(response.data.data.height, response.data.data.txid)
                        this.viewTxOutsInside(response.data.data.height, response.data.data.txid)
                      } else {
                        this.message = "unspent"
                      }
                    }
                  )
              },

              updateTxIns: function(txid, url) {
                this.message = "..."
                axios
                  .get(url)
                  .then(
                    response => {
                      if (response.data.code == 0) {

                        this.currTxIdForIn = txid
                        this.currTxIns = response.data.data

                        this.currTxIdInputValue = 0
                        for(let i = 0; i < this.currTxIns.length; i++) {
                          this.currTxIdInputValue += this.currTxIns[i].satoshi
                        }

                      }
                      this.message = response.data.msg
                    }
                  )
              },

              updateTxOuts: function(txid, url) {
                this.message = "..."
                axios
                  .get(url)
                  .then(
                    response => {
                      if (response.data.code == 0) {
                        this.currTxIdForOut = txid
                        this.currTxOuts = response.data.data

                        this.currTxIdOutputValue = 0
                        for(let i = 0; i < this.currTxOuts.length; i++) {
                          this.currTxIdOutputValue += this.currTxOuts[i].satoshi
                        }
                      }
                      this.message = response.data.msg
                    }
                  )
              },


              viewTxOutpointByAddress: function (address) {
                this.currAddress = address
                this.currAddressTxOuts = []

                axios
                  .get(this.apiPoint + "address/"+ address +"/utxo")
                  .then(
                    response => {
                      this.currAddressTxOuts = response.data.data
                    }
                  )
              },

            }
        })
    </script>
  </body>
</html>
